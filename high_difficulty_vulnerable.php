<?php
// high_difficulty_vulnerable.php

$file_path = 'latest_data.txt';

if (isset($_POST['data'])) {
    $data = $_POST['data'];

    // Multiple levels of "sanitization"
    $sanitized_data = htmlspecialchars($data, ENT_QUOTES, 'UTF-8');
    $sanitized_data = preg_replace('/<script.*?>/si', '', $sanitized_data); // Remove <script> tags only
    $sanitized_data = str_replace('on', '', $sanitized_data); // Remove common event handlers like "onerror", "onload", etc.
    
    file_put_contents($file_path, $sanitized_data);
}

$latest_data = (file_exists($file_path)) ? file_get_contents($file_path) : "";

// Decode the htmlspecialchars for the purpose of this challenge
$latest_data = htmlspecialchars_decode($latest_data);

?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Difficulty XSS Challenge</title>
    <!-- Strict CSP for added difficulty -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self';">
</head>
<body>
    <h1>Submit Your Data</h1>
    <form method="POST" action="">
        <textarea name="data"></textarea><br>
        <input type="submit" value="Submit">
    </form>
    <hr>
    <div>Your latest data: <?php echo $latest_data; ?></div>
</body>
</html>
